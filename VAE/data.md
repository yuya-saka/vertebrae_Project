# 3D椎体骨折検出に向けたデータ前処理仕様書

## 1. 目的

本前処理パイプラインは、従来の2Dスライス分類アプローチ から脱却し、**「3D VAEを用いた正常構造の学習」** および **「バウンディングボックスを用いた弱教師あり学習」** を実現するための3Dボリュームデータセットを構築することを目的とする。

## 2. 前処理パイプラインの概要

入力された胸椎・腰椎CTデータ（NIfTI形式）に対し、以下の処理を一貫して行い、学習用データ（`.npy`）と確認用データ（`.nii.gz`）を出力する。

### 2.1 空間解像度の統一（等方性リサンプリング）

AIモデル（3D CNN/VAE）の入力要件と、物理的なカバレッジのバランスを考慮し、以下の仕様に統一した。

- **ターゲットサイズ:** $128 \times 128 \times 128$ voxels
    
- **物理的視野 (FOV):** $128\text{mm} \times 128\text{mm} \times 128\text{mm}$
    
- **実質解像度:** $1.0\text{mm} \times 1.0\text{mm} \times 1.0\text{mm}$ （等方性）
    
- **処理手法:**
    
    1. 元のCT画像の解像度（Spacing）から、物理的に128mmとなるボクセル数を算出。
        
    2. 椎体重心を基準にクロッピング（画像端の場合はゼロパディングを実施）。
        
    3. GPU（PyTorch）を用いた `Trilinear` 補間により $128^3$ にリサイズ。
        

### 2.2 CT値の正規化（Bone Window）

骨構造を明確にし、軟部組織ノイズを除去するため、以下のウィンドウ設定を適用した。

- **ウィンドウ範囲:** $0 \text{ HU} \sim 1900 \text{ HU}$
    
- **正規化手法:** Min-Max Scalingにより $[0.0, 1.0]$ の範囲に変換。
    
    - $0 \text{ HU}$ (水/軟部組織) $\rightarrow 0.0$
        
    - $1900 \text{ HU}$ (皮質骨) $\rightarrow 1.0$
        
- **補足:** 椎体内部（海綿骨）は $100 \sim 300 \text{ HU}$ 程度であるため、正規化後は $0.05 \sim 0.15$ 付近の値となり、視覚的には暗く見えるが、AIの学習データとしては密度情報が正しく保持されている。
    

### 2.3 ラベル生成（弱教師あり学習用）

精密なセグメンテーションマスク（正解データ）から、学習に必要なラベルを生成した。

- **弱ラベル (Weak Label):**
    
    - 正解マスクの存在範囲（最大・最小座標）を計算し、その範囲を「1」で埋めた **3Dバウンディングボックス（箱）** を生成。
        
    - 詳細な形状情報をあえて欠落させ、粗い位置情報のみを学習に使用する。
        
- **正解マスク (Ground Truth):**
    
    - 評価および将来的な強教師あり学習への移行を見据え、リサイズ済みの詳細マスクも保存。
        

## 3. 出力データ構成

学習効率（I/O速度）と運用性（可視化確認）を両立させるため、以下のディレクトリ構造とフォーマットを採用した。

### 3.1 ディレクトリ構造

Plaintext

```
data/3d_data/
├── train_vae/             # VAE学習用（正常椎体のみ）
│   └── vol_{ID}_{椎体番号}.npy
│
├── train_det/             # 骨折検出モデル学習用（全データ）
│   ├── vol/               # CT入力データ (.npy)
│   ├── mask_weak_label/   # 弱ラベル/3D Box (.npy)
│   └── mask_gt_label/     # 正解マスク/評価用 (.npy)
│
└── visualization/         # 人間による確認用（ITK-SNAP等で閲覧可能）
    ├── vol/               # CT入力データ (.nii.gz)
    ├── mask_weak/         # 弱ラベル (.nii.gz)
    └── mask_gt/           # 正解マスク (.nii.gz)
```

### 3.2 ファイルフォーマットの使い分け

- **学習用 (`.npy`):**
    
    - NumPyバイナリ形式。
        
    - ヘッダー解析不要でメモリマップ読み込みが可能なため、学習時のデータロードが高速。
        
- **確認用 (`.nii.gz`):**
    
    - NIfTI形式（Gzip圧縮）。
        
    - 3D Slicerなどの医療画像ビューアで座標や画素値を確認するために生成。
        
    - ※大量生成時のボトルネックとなるため、本番処理時は生成をスキップ可能とした。
        

## 4. 実装環境とツール

- **言語:** Python
    
- **主要ライブラリ:**
    
    - `Nibabel`: NIfTI形式の読み書き。
        
    - `PyTorch`: GPUを使用した高速な3Dリサイズ処理 (`torch.nn.functional.interpolate`)。
        
    - `NumPy`: 配列操作およびバイナリ保存。
        
- **ハードウェア:** NVIDIA GPU (CUDA) を使用し、CPU処理に比べて大幅な高速化を実現。