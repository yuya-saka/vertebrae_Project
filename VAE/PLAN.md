
## 🏔️新アプローチの全体像： VAE ＋ 弱教師あり学習
この手法は、大きく分けて「正常パターンの学習フェーズ」と「骨折検出の学習フェーズ」の2段階で構成されます。

### 概要フロー

1. **[フェーズ1： VAE学習]**
    - `[正常な3D椎体データ]` → `[3D VAE]` → `[学習（正常な再構成を学習）]`    
    - **目的：** VAEに「正常な椎体」の形状と構造だけを学習させ、"正常再構成モデル" を作成します。
        
2. **[フェーズ2： 骨折検出モデル学習]**
    - `[全3Dデータ (正常+骨折)]` → `[学習済みVAE (重み固定)]` → `[3D再構成誤差マップ]`    
    - `[3D再構成誤差マップ]` + `[骨折範囲の弱ラベル]` → `[骨折検出モデル (3D U-Net等)]` → `[3D骨折確率マップ]`    
    - `[3D骨折確率マップ]` → `[提案の複合Loss関数 (下記参照)]` → `[モデルの重み更新]`
        
---

## ⚙️ ステップ1： 正常パターンの学習 (VAE)

- 目的：椎体の「正常な状態」を学習します。骨折などの異常データは学習に含めません。
    
- データ：**正常（健常）**と判断された椎体の3Dデータのみ。
    
- プロセス：3D VAE（Variational Autoencoder）を学習させます。VAEは入力された正常データを圧縮し、元に戻す（再構成する）タスクを行います。
    
- 結果：「正常データを再構成すること」に特化したモデルが完成します。このモデルに未知のデータ（骨折データ）を入力すると、学習していないパターン（骨折部）の再構成に失敗し、その部分に大きな再構成誤差（入力と出力の差）が生じます。
    
---

## 🎯 ステップ2： 骨折検出モデルの学習 (弱教師あり)

- 目的：VAEが生成した「再構成誤差」をヒントに、骨折箇所を特定する3D確率マップを出力するモデルを学習します。
    
- データ：正常および骨折、両方の3Dデータ。
    
- **入力：**
    1. **3D再構成誤差マップ：** ステップ1のVAEに全データを入力して生成した「再構成誤差」の3Dマップ。
    2. **骨折範囲の弱ラベル：** 骨折箇所を正確にピクセル単位でアノテーションしたものではなく、「この辺りに骨折がある」という大まかな3Dバウンディングボックス（弱ラベル）。
        
- アーキテクチャ：3D U-NetやV-Netのような、3Dセグメンテーションモデル。このモデルがVAEの再構成誤差マップを入力として受け取ります。
    
- 出力：3D骨折確率マップ（各ボクセルが骨折である確率 $P_{\text{fracture}}$ を示す）。
    
---

## 🧮 提案の複合Loss関数の構成

ご提案いただいた4つの評価項目を、骨折検出モデルを学習させるための複合Loss関数として定義します。
$P$ をモデルが出力する骨折確率マップ、 $M_{\text{inside}}$ を弱ラベルの範囲内マスク、 $M_{\text{outside}}$ を弱ラベルの範囲外マスクとします。
全体のLossは、これらの重み付き和 $L_{\text{total}}$ となります。

$$L_{\text{total}} = \lambda_1 L_1 + \lambda_2 L_2 + \lambda_3 L_3 + \lambda_4 L_4$$

### 項目1： 範囲外ペナルティ (BCE Loss)

- **ご提案内容：** `範囲外： 強い負例（p = 0） ＞ ロス関数 BCEですべてが０`
    
- **目的：** 弱ラベルの**範囲外** ($M_{\text{outside}}$) は、確実に骨折ではない（True Negative）と仮定し、モデルの予測確率を $0$ に近づけます。
    
- Loss関数 $L_1$：
    $$L_1 = \text{BCE}(P[M_{\text{outside}}], 0)$$
    （範囲外のボクセルに対するBCE Loss）
    
### 項目2： 範囲内ペナルティ (MIL - Average Loss)

- **ご提案内容：** `スライスレベルの弱ラベル...平均を求めてBCEを求める`
    
- **目的：** 弱ラベルの**範囲内** ($M_{\text{inside}}$) には、少なくとも1つ以上の骨折ボクセルが存在する（True Positive）と仮定します。これはMultiple Instance Learning (MIL) の考え方です。範囲内の全ボクセルの確率の**平均値**を $1$ に近づけます。
    
- Loss関数 $L_2$：
    $$L_2 = \text{BCE}(\text{Average}(P[M_{\text{inside}}]), 1)$$
### 項目3： 範囲内外のコントラスト (Max Loss)

- **ご提案内容：** `最大値を用いて、範囲外と範囲内の差をLoss関数に用いる`
    
- **目的：** モデルが最も「骨折らしい」と予測した箇所（確率の最大値）に注目します。範囲**内**の最大確率 $\text{max}(P[M_{\text{inside}}])$ は、範囲**外**の最大確率 $\text{max}(P[M_{\text{outside}}])$ よりも高くなるように学習させます。
    
- Loss関数 $L_3$：
    $$L_3 = \text{max}(0, \text{max}(P[M_{\text{outside}}]) - \text{max}(P[M_{\text{inside}}]) + \text{margin})$$
    
    （Contrastive Loss / Hinge Lossの一種）
    
### 項目4： VAEとの一貫性 (Reconstruction Error Loss)

- **ご提案内容：** `再構成誤差と骨折確率マップとの一貫性`
    
- **目的：** VAEが生成した再構成誤差マップ ($E_{\text{VAE}}$) は、骨折確率の強力なヒントです。モデルが出力する骨折確率マップ ($P$) は、この $E_{\text{VAE}}$ と形状や位置が一貫しているべきです。
    
- Loss関数 $L_4$：
    $$L_4 = \text{L1\_Loss}(P, \text{Normalize}(E_{\text{VAE}}))$$
    
    （再構成誤差マップ（正規化済み）と確率マップのL1（またはL2）距離）


### 用いるアノテーション
- スライスレベルのラベル
- 骨折箇所単位のラベル(3Dの骨折領域を囲んだboundhing box)
の二種類、どっちが使えるか？
スライスレベルで精度よければ大きい

## スライスレベルvsBBレベル

### 共通設定（前提）

- **モデル入力:** 3D VAEによる「再構成誤差マップ ($E$)」と「元のCT画像 ($X$)」
    
- **モデル出力:** 3D骨折確率マップ $P$ （各ボクセル値 $0.0 \sim 1.0$）
    
- **Loss構成:** $L_{\text{total}} = \lambda_1 L_{\text{outside}} + \lambda_2 L_{\text{inside}} + \lambda_3 L_{\text{contrast}} + \lambda_4 L_{\text{consistency}}$
    

---

### 🅰️ アプローチ A： スライスレベル (Slice-level) での学習

**「骨折はこの高さ（Z軸）のどこかにあるが、断面（XY）のどこかは不明」**という状態です。

### 1. ラベル定義

- ラベル情報： $Z_{\text{start}} \sim Z_{\text{end}}$ （例：スライス50番〜60番）
    
- 意味：このZ軸区間のスライス全体を「異常候補」とし、それ以外のZ軸を「正常」とする。
    

### 2. マスクの定義 (ここが重要)

- **範囲内マスク ($M_{\text{inside}}$):**
    
    - 指定されたZ軸範囲に含まれる**全XY平面**。
        
    - 領域：極めて**広い**（骨も、内臓も、背景も含む）。
        
- **範囲外マスク ($M_{\text{outside}}$):**
    
    - 指定されたZ軸範囲**以外**のスライス全体。
        

### 3. Loss設計の詳細

- $L_1$: 範囲外ペナルティ (BCE)
    
    $$L_1 = \text{BCE}(P[Z \notin \text{range}], 0)$$
    
    - **動作:** 指定範囲外のスライスはすべて0に近づける。
        
- $L_2$: 範囲内ペナルティ (MIL)
    
    $$L_2 = \text{BCE}(\text{GlobalMax}(P[Z \in \text{range}]), 1)$$
    
    - **動作:** 指定スライス群（512x512x枚数）という巨大な領域の中で、**「少なくとも1点（最大値）」**が1になればOKとする。
        
    - _※平均(Average)を使うと、正常画素が多すぎて値が薄まるため、Max推奨。_
        
- $L_3$: コントラスト (Max Difference)
    
    $$L_3 = \text{max}(0, \max(P_{\text{outside}}) - \max(P_{\text{inside}}) + \text{margin})$$
    
    - **動作:** 範囲内のピーク値が、範囲外のノイズよりも高くなるようにする。
        

### 4. 学習の挙動（デメリット）

- $M_{\text{inside}}$ が広すぎるため、モデルは「骨折」に反応すべきか、「スライス内の血管」に反応すべきか迷いやすく、学習が不安定になりやすい。
    
- 骨折以外の高信号（アーチファクトなど）を拾うリスクが高い。
    

---

### 🅱️ アプローチ B： BB (Bounding Box) レベルでの学習

**「骨折はこの3Dの箱（XYZ）の中にある」**という状態です。

### 1. ラベル定義

- ラベル情報： $(x_{\min}, y_{\min}, z_{\min})$ 〜 $(x_{\max}, y_{\max}, z_{\max})$
    
- 意味：この直方体内部を「異常候補」とし、**それ以外の3D空間すべて**を「正常」とする。
    

### 2. マスクの定義 (ここが重要)

- **範囲内マスク ($M_{\text{inside}}$):**
    
    - 指定された**3Dボックス内部のみ**。
        
    - 領域：極めて**狭い**（骨折部位とその周辺のみ）。
        
- **範囲外マスク ($M_{\text{outside}}$):**
    
    - **3Dボックスの外側すべて**。
        
    - ※スライスレベルでは「範囲内（正解候補）」になっていた同スライス内の血管や臓器が、ここでは「範囲外（不正解）」に変わります。
        

### 3. Loss設計の詳細

- $L_1$: 範囲外ペナルティ (BCE)
    
    $$L_1 = \text{BCE}(P[(x,y,z) \notin \text{Box}], 0)$$
    
    - **動作:** 箱の外にあるものは、例え同じスライス上の骨や血管であっても**「それは骨折ではない(0だ)」と強く否定**できる。これが最強の強み。
        
- $L_2$: 範囲内ペナルティ (MIL)
    
    $$L_2 = \text{BCE}(\text{Average}(P[(x,y,z) \in \text{Box}]), 1)$$
    
    - **動作:** 箱の中は狭く、骨折が占める割合が高いため、**「平均(Average)」**を使っても十分な勾配が得られる。Maxを使っても良いが、Averageの方が箱全体を埋めようとするため、セグメンテーション形状がきれいに出やすい。
        
- $L_3$: コントラスト (Max/Avg Difference)
    
    $$L_3 = \text{max}(0, \text{Avg}(P_{\text{outside}}) - \text{Avg}(P_{\text{inside}}) + \text{margin})$$
    
    - **動作:** 箱の中と外の差を明確にする。
        

### 4. 学習の挙動（メリット）

- 「ここ以外は全部ダメ」という制約（$L_1$）が非常に強力にかかるため、ノイズが消える。
    
- 探索範囲（$M_{\text{inside}}$）が狭いため、モデルが即座に骨折の特徴（エッジや不連続性）を見つけ出し、収束が早い。
    

---

## 比較まとめ

|**特徴**|**🅰️ スライスレベル (Z範囲)**|**🅱️ BBレベル (3D箱)**|
|---|---|---|
|**入力ラベル**|$Z_{start} \sim Z_{end}$|$(x,y,z)_{min} \sim (x,y,z)_{max}$|
|**$M_{\text{inside}}$ の広さ**|**広大** (全画素の数%〜10%)|**極小** (全画素の0.1%以下)|
|**$M_{\text{outside}}$ の定義**|対象スライスの**外側のみ**|箱の**外側すべて** (同スライス内も含む)|
|**強い負例 ($L_1$)**|Z軸方向のみ抑制|**XYZ全方向から抑制 (強力)**|
|**推奨Aggregation**|**Max** (埋もれるのを防ぐため)|**Average** (箱全体を捉えるため)|
|**セグメンテーション精度**|**粗い** (スライス全体が反応しがち)|**細かい** (骨折局所に集中しやすい)|

### 結論

BBレベルのアプローチは、**$L_1$（範囲外ペナルティ）の適用範囲が圧倒的に広い**ため、誤検出（False Positive）を劇的に減らすことができます。

同じアーキテクチャであっても、**Loss関数に渡すマスクを「スライス全体」から「BB領域」に変えるだけ**で、性能は別物になります。




## 新規性、貢献

この新しい手法における「新規性（Originality/Novelty）」の主張は、これまでの卒業論文の手法（2Dスライス分類）との対比、および一般的な深層学習研究の文脈の両面から、以下の3点に集約できると考えられます。

### 1. アノテーションコストを大幅に削減する「弱教師あり3Dセグメンテーション」の実現

従来の3D骨折検出（例：3D U-Netを用いた手法）では、学習データ作成のために専門医がスライスごとに正確な骨折領域を塗りつぶす（Pixel-level annotation）必要があり、これが臨床応用への最大の障壁でした。

- **新規性の主張:** 本手法は、作成が容易な「3Dバウンディングボックス（弱ラベル）」のみを教師データとして用いることで、**アノテーションコストを劇的に低減（例：1/10〜1/100）**させつつ、ボクセル単位での高精度な骨折領域特定（セグメンテーション）を可能にする点です。
    
### 2. 「異常検知（VAE）」と「弱教師あり学習」の融合による精度向上メカニズム

単にバウンディングボックスを用いた弱教師あり学習（MILなど）を行うだけでは、箱の中の「どこ」が骨折なのかを特定するのは困難であり、箱全体を陽性と判定してしまう「過検出」が課題となります。

- **新規性の主張:** 本研究は、**VAE（変分オートエンコーダ）による正常椎体の再構成誤差**を「ピクセルレベルの注目領域（Attention map）」として弱教師あり学習に組み込む点に独創性があります。 「箱（BBox）」で大まかな位置を教え、「再構成誤差」で細かな形状を教えるという、**異なる2つの不完全な情報を相補的に組み合わせる**ことで、完全な教師データなしで精密なセグメンテーションを実現する新しいアーキテクチャを提案しています。
    
### 3. 3D空間情報を活用した「未知の異常（骨折）」への汎化性能

卒業論文の手法では、多方向の2Dスライス画像を個別に判定してから統合しており、3次元的な連続性が考慮されていませんでした。また、一般的な分類モデルは「学習したパターンの骨折」しか検出できません。

- **新規性の主張:** 本手法は、**正常な椎体形状を学習したVAE**をベースとするため、特定の骨折パターンに依存せず、「正常からの逸脱」として骨折を検出できます。これにより、学習データに含まれていない珍しい形状の骨折や、微細な変形に対しても頑健（ロバスト）な検出が期待でき、2Dスライス分類では捉えきれない**3次元的な構造破綻**を検知可能です。

---

### 論文・発表での構成案（例）

**「本研究は、以下の3点において新規性を有する。」**

1. **手法の独創性:** VAEによる再構成誤差マップを事前知識として導入し、3Dバウンディングボックスを用いた弱教師ありセグメンテーションの空間的曖昧性を解消する新たなフレームワークを構築した点。
    
2. **実用性・効率性:** 従来必須であったボクセル単位の精密なアノテーションを不要とし、粗いラベルのみで学習可能にすることで、医療現場におけるAI導入の最大のボトルネックである「教師データ作成コスト」を解消した点。
    
3. **3D解析への拡張:** 従来の2Dスライスベースの判定から脱却し、3次元ボクセルデータを直接解析することで、椎体の立体的構造破綻を高感度かつロバストに検出可能とした点。

## 研究の目的とするところ

### 1. 研究の着地点：「Pseudo-Labeling（擬似ラベル）生成器」としての提案

今回の手法（VAE + BBox）を、最終的な診断モデルとして終わらせるのではなく、**「将来、最強の教師ありモデル（Strongly Supervised Model）を作るための『マスク生成ツール』」**として位置づけます。

#### 提案するストーリーライン

1. 現状の課題:3Dセグメンテーションを行うには、スライスごとに正確なマスクを描く必要があり、医師の負担が限界を超えている 1。
    
2. 本研究の提案（Step 1）:医師は「ここら辺が怪しい」という**3Dの箱（BBox）を指定するだけでよい。本研究のモデル（VAE+弱教師あり）が、その箱の中から骨折形状を推定し、「擬似的なマスク（Pseudo-Mask）」**を生成する。
    
3. 将来への展望（Step 2 - Human-in-the-loop）:AIが生成した「擬似マスク」を医師が確認し、微修正するだけで、**正確な教師データ（強ラベル）**が完成する。
    
4. 最終形態（Step 3）:こうして量産された「正確な教師データ」を使って、改めて一般的な高性能モデル（nnU-Netなど）を学習させれば、最終的にはBBoxすら不要な完全自動化モデルができる。    

**→ つまり、本研究は「診断AI」を作っていると同時に、「未来の学習データを自動生成するAI」を作っている、という着地です。**

---
### 2. なぜ「スライスラベル」ではなく「3D BBox」なのか？

質問にあった「画像スライスにラベル付けする（2D Classification）」という選択肢と比較して、なぜ今回の「3D BBox」の方が優れているかを論文で主張する必要があります。

|**手法**|**アノテーションの手間**|**得られる情報**|**将来性（マスク作成への貢献）**|
|---|---|---|---|
|**2Dスライスラベル**|**非常に楽** (Yes/Noのみ)|**低い** (どこが折れているか不明)|× マスクを作るには情報不足。CAM等はぼやけやすい。|
|**3D Pixel Mask**|**非常に大変** (塗り絵)|**最高** (形状・位置が正確)|◎ 理想だが、作れないのが現状の課題。|
|**本研究 (3D BBox)**|**楽** (箱で囲むだけ)|**高い** (3Dの位置と範囲)|**◎ VAEと組み合わせることで、Pixel Maskに近い情報を復元可能。**|

主張のポイント:「スライスラベル（Yes/No）」まで簡略化してしまうと、3次元的な骨折の形状（どこがどう潰れているか）という重要な空間情報が失われてしまいます。
3D BBoxは、**「医師が許容できる手間の軽さ」と「3Dセグメンテーションに必要な空間情報」の最適なバランス（スイートスポット）**に位置している、と主張できます。

---

### 3. 論文の「まとめ（Conclusion）」の書き方イメージ

これらを踏まえると、論文や発表の「まとめ」は以下のようになります。

> 本研究では、3DバウンディングボックスとVAEを用いた弱教師あり学習手法を提案した。
> 
> 実験の結果、ボクセル単位の精密なアノテーションを用いずとも、粗い位置情報と正常構造の再構成誤差のみで、骨折部位の3次元的な抽出が可能であることが示唆された。
> 
> （ここからが着地）
> 
> 今後の展望として、本手法を**「アノテーション支援ツール」**として活用することが挙げられる。本モデルが出力する骨折確率マップを「初期マスク（Pseudo-label）」として利用し、医師がわずかな修正を加えるプロセス（Human-in-the-loop）を構築すれば、学習データの作成コストを従来の数十分の一に削減できる。
> 
> これにより、大規模な3D骨折データセットの構築が容易になり、将来的にはよりロバストな完全自動診断システムの実現に貢献すると考えられる。

---

### 結論

今回の研究手法は、以下のように着地させてください。

- **手法:** 「3D BBox（弱ラベル）」＋「VAE（異常検知）」
    
- **目的:** アノテーションコストの最小化と、骨折領域の可視化の両立。
    
- **将来のビジョン:** このAIを使って「大量のマスクデータ」を半自動的に作り出し、最終的にはより強力なAIを育てるための**「基盤技術（Foundation）」**とする。
    
「マスクを簡単に作る方法」を探求する姿勢として、このアプローチは非常に論理的で、工学的価値が高いものです。

### 🚀 骨折検出AIの進化ロードマップ

#### 第1段階： コールドスタート（今回の研究範囲）

- **入力：** 少量のデータ ＋ **「3Dバウンディングボックス（弱ラベル）」**
    
- **エンジン：** **VAE（異常検知）** ＋ 弱教師あり学習モデル
    
- **状態：** 教師データが不完全（箱だけ）でも、VAEが「正常とは違う場所」を教えてくれるため、なんとか骨折形状（マスク）を予測できる。
    
- **成果：** 「精度はそこそこだが、3Dの骨折箇所を特定できるモデル」が誕生。
    
#### 第2段階： 擬似ラベル（Pseudo-Labeling）の大量生成

- **アクション：** 学習済みモデルに、**ラベルのない大量のCTデータ**を入力する。
    
- **プロセス：** AIが勝手に骨折箇所を予測し、**「擬似マスク（AIが作った仮の正解）」**を生成する。
    
- **意味：** 人間が一切作業することなく、大量の（しかし不完全な）教師データが手に入る。
    
#### 第3段階： 人間による修正（Human-in-the-loop）

- **アクション：** 医師がAIの作った「擬似マスク」を確認する。
    
- **効率化の鍵：** ゼロからマスクを塗り絵するのは数十分かかるが、**「AIが描いたマスクの少しズレた部分を消しゴムで直す」だけなら数秒〜数分で終わる。**
    
- **成果：** 爆速で「高品質な正解マスク（強ラベル）」が蓄積されていく。
    
#### 第4段階： 最終進化（強教師あり学習への移行）

- **アクション：** 第3段階で集まった「高品質マスク」を使って、今度は**通常の最強モデル（nnU-Netなどの全教師あり学習）**を学習させる。
    
- **結果：** VAEや弱ラベルの制約から解放され、純粋なデータ量と質で殴る「実用レベルの超高精度モデル」が完成する。
    
---
### 💡 この研究の「着地」としての凄さ

このストーリーにより、あなたの研究（第1段階）の価値は単なる「骨折検出」に留まらなくなります。

- **Before（従来の研究）：** 「先生、精度を上げたいので、あと1000枚マスクを描いてください」 → 医師「無理です（研究終了）」
    
- **After（あなたの研究）：** 「先生、まずはこの箱（BBox）だけでAIを作りました。このAIがマスクの下書きをするので、あとは楽に修正してデータを増やせます。**私が作ったのは、先生の苦労を減らしながら、最終的に最強のAIを作るための『エンジン』です**」 → 医師「それならできる！（研究継続・実用化へ）」
    
### 結論

あなたの考えた**「弱教師ありでどんどん学習していき、最終的に豊富なデータによる検出へと進化する」**という構想は、AI開発の現場で最も求められている**「データの好循環（Data Flywheel）」**そのものです。

論文の考察や今後の展望には、ぜひこの**「将来的なデータ生成サイクルへの貢献」**を堂々と記述してください。非常に説得力のある「着地」になります。

## docs
- ./data.md: 学習用のデータセットの詳細
- ./fold_plan.md: fold分けの詳細

## 実装手順

- PyTorch Lightning + Hydra + timm (3D)
- まずは正常データのみでVAEを学習。timm の3DモデルをEncoderに使うことも可能だが、VAEはDecoder（復元）が必要なため、シンプルな3D CNNで構築するのが一般的かつ制御しやすい

