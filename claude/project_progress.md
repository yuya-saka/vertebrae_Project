## 基本的に自分用の整理

### 2025/10/7
- Unetを使った実装に決定
- まず、リポジトリを整えるところから
  - trainとteatにデータわける
     ->テストデータに割り当てられた症例数: 8 症例、訓練データに割り当てられた症例数: 30 症例
     ->成功
### 2025/10/8
- ==ディレクトリ構造をしっかり考える必要がある==。ちゃんと役割を考えないと、膨大な設計になり管理できず4ぬから
- 設定を明示的にする。
	- HUは0から1800
	- 画像スケールをそろえる必要あり、cut_li.txtで作成した椎体ボリュームの大きさに差があることが判明
	  そのため、アスペクト比は変えずに、ゼロパディング等で調整する
	- wandbの設定
	- ちゃんとfoldを分けて実装するようにする
- LSTM学習のためには、椎体部位間で自然につながるようにしないといけない、
  そのため、データ切り出し時点でやり方を変える必要あり
### 2025/10/10
- まず、unetのみでのmodelを作り、学習、評価まで行うことを目標とする
     - そのため、まず、入力するためのデータ準備と、Unetのアーキテクチャと学習設定を考える
        - チャネル数どうするか
     - 画像可視化でデータ入力策検討
        - 256×256でリサイズによる正規化ありかも
        - 3チャンネルで、HU幅を変えて入力する
            候補：
            - 0,1800
            - 200,1200
            - -160, 240
            - -300, 800
        - スライス間比率1:9、骨折ピクセルの全体に対する比率　0.6%
     - 学習設定
        - データ拡張行う
          - 学習時に生成する（オンライン）拡張
          - スライス画像間のクラス比率を同じになるよう拡張する
          - スライス間連続性の保持
        - Focal lossやTversky loss

### 2025/10/12
- **データ分布分析完了**
  - ✅ Train/Testのクラス分布調査完了
    - Train: 骨折スライス 10.83% (4,963 / 45,815枚)
    - Test: 骨折スライス 9.39% (1,286 / 13,691枚)
  - ✅ 骨折マスクのピクセル比率調査完了
    - Train: 平均 0.616% (149.5ピクセル/枚)
    - Test: 平均 0.553% (142.0ピクセル/枚)
  - ✅ 椎体ごとの骨折分布確認
    - V30-V32で骨折が多い（20-25%）
    - V27, V40で骨折が少ない（1-3%）
  - スクリプト: `notebook/data_distribution_analysis.py`

- **データ拡張戦略の決定**
  - ✅ オンライン拡張の方針決定
  - ✅ クラス比率均衡化の方針決定
    - 目標: 骨折スライス 50% （現状10.8% → 50%）
    - 骨折スライスを約9倍にオーバーサンプリング
  - ✅ スライス間連続性保持の実装方針決定
    - 椎体単位で同じ変換パラメータを適用
    - 回転・平行移動・スケーリング・反転は全スライス統一
    - 輝度・ノイズは独立適用可能
  - 実装: `src/datamodule/augmentation.py`

- **Phase 1実装完了** - 2025/10/12
  - ✅ Hydra設定ファイル構築完了
    - HU範囲、画像サイズ、拡張パラメータの定義
  - ✅ データセット実装完了（Dataset/DataLoaderクラス）
    - 3チャンネルHU入力生成
    - オンライン拡張機能の統合
    - 骨折スライスのオーバーサンプリング（9倍）
    - 患者レベルでのtrain/val分割
  - ✅ Attention U-Netモデル実装完了
    - Attention Gate実装
    - U-Net本体実装（depth=4, init_features=64）
  - ✅ LightningModule実装完了
    - 損失関数（Dice + BCE）
    - 評価指標（Dice, IoU, Precision, Recall, F1）
  - ✅ 学習スクリプト実装完了

- **次のステップ**
  - [ ] セットアップテストの実行
  - [ ] 学習の実行（fold 0から開始）
  - [ ] 学習結果の評価と分析