
### **研究実装計画書：Attention U-NetとLSTMを用いた椎骨骨折セグメンテーション**

#### **1. 研究背景と目的**

前回の研究「スライス画像分類による椎骨骨折検出」では、ResNet18を用いた分類モデルを構築しましたが、テストデータにおけるPR-AUCが0.17と低く、骨折領域の位置特定精度に深刻な課題が残りました。この課題は、スライス単位の「分類」タスクでは、骨折の正確な「位置」情報を捉えきれないという根本的な問題に起因します。

本研究ではこの課題を克服するため、アプローチを根本から見直します。**Attention U-Netによる画像セグメンテーション**と**LSTMによるスライス間コンテキストの学習**を融合させた新たな時空間モデルを構築し、CT画像から椎骨骨折領域を3次元的に高精度で特定することを目的とします。特にAttention機構の導入により、微小な骨折領域など、重要度の高い特徴へモデルの注意を集中させ、セグメンテーション精度の向上を目指します。

---

#### **2. 提案手法の概要**

本研究では、以下の4つのステップで骨折検出と評価を行います。

1. **手法の転換 (Attention U-Net)**: 骨折の有無を判定する「分類」から、骨折領域をピクセル単位で塗り分ける「セグメンテーション」へタスクを転換します。特に**Attention U-Net**を用いることで、骨折領域のような小さく重要な特徴を学習の過程で自動的に強調させ、位置と形状をより正確に捉えます。
    
2. **3D情報の導入 (LSTM)**: 連続する複数枚の2Dスライス画像を1つのシーケンスデータとして扱い、Attention U-Netによって抽出された特徴量をLSTMに入力します。これにより、スライス間の連続性（奥行き方向のコンテキスト）を学習させます。
    
3. **2.5D統合による3D復元**: 各椎体（T4-L5）ごとに独立して推論を行い、得られた2Dのセグメンテーション結果を元の3Dボリュームデータ上で統合（平均化や投票方式）し、3次元の骨折確率マップを生成します。
    
4. **評価と可視化**: 3Dの確率マップを教師データ（3Dアノテーションマスク）と比較し、Dice係数やIoU (Intersection over Union) などのセグメンテーション指標で精度を評価します。結果はヒートマップや3Dレンダリングで可視化します。
    

---

#### **3. 実装計画 (Implementation Plan)**

**Phase 1: データ前処理 (Data Preprocessing)**

- **椎体領域の抽出**: 既存研究と同様に、T4からL5までの各椎体をバウンディングボックスで手動または自動で切り出します。
    
- **シーケンスデータの作成**:
    
    - 各椎体のスライス群をシーケンスデータに変換します。例えば、5枚の連続するスライス（`[t-2, t-1, t, t+1, t+2]`）を入力とし、中央のスライス（`t`）の骨折セグメンテーションマスクを正解ラベルとするデータセットを構築します。
        
    - 回転、スケール、輝度調整などのデータ拡張を積極的に行い、モデルの汎化性能を高めます。
        

**Phase 2: モデルアーキテクチャ設計と実装**

- **基本アーキテクチャ**: **Attention U-Net + LSTM**
    
- **コンポーネント1: Attention U-Net**
    
    - **役割**: 入力されたCT画像スライスから空間的特徴を抽出し、骨折領域のセグメンテーションマップを生成します。
        
    - **Attention機構**: エンコーダからデコーダへのスキップ接続部分に**Attention Gate**を挿入します。これにより、デコーダは再構成の際に、エンコーダからの特徴マップの中から骨折領域と関連の深い部分のみを選択的に利用でき、ノイズや無関係な背景情報の影響を抑制します。
        
- **コンポーネント2: LSTM**
    
    - **役割**: 連続するスライスからAttention U-Netのエンコーダによって抽出された特徴量の系列を受け取り、時間的（スライス間）な依存関係を学習します。
        
- **統合アーキテクチャ案**:
    
    1. シーケンス内の各スライス画像を**Attention U-Netのエンコーダ**に入力し、特徴ベクトル（ボトルネック部分）を抽出します。
        
    2. 抽出された特徴ベクトルのシーケンス（例: 5枚分）を**LSTM層**に入力し、時間的コンテキストを考慮した特徴量に変換します。
        
    3. LSTM層の出力を、**Attention U-Netのデコーダ**の初期入力とします。
        
    4. デコーダは、Attention Gateを介したスキップ接続によってエンコーダから空間的に重要な情報を受け取りながら、最終的なセグメンテーションマスクを生成します。
        

**Phase 3: 学習と評価 (Training & Evaluation)**

- **学習**:
    
    - **損失関数**: セグメンテーションタスクで一般的に用いられる**Dice損失**と**バイナリクロスエントロピー損失**を組み合わせた複合損失を基本とします。さらに、pix2pixの考え方を応用し、Discriminator（弁別器）を導入して**敵対的損失**を加えることで、よりシャープで現実的なセグメンテーション境界の生成を目指します。
        
    - **最適化**: **Adam** または AdamW を使用します。
        
- **評価**:
    
    - **2.5D評価**: まずは2Dスライス単位でセグメンテーション精度を評価します（Dice係数、IoU）。
        
    - **3D評価**: Phase 2で生成した3D確率マップに対し、適切な閾値を設定して二値化します。この3D予測マスクと3D正解マスクを比較し、**3D Dice係数**、**IoU**、**適合率 (Precision)**、**再現率 (Recall)** を算出します。
        

**Phase 4: 結果の可視化 (Results Visualization)**

- **ヒートマップ可視化**: 3D確率マップを元のCT画像に重ね合わせ、骨折確率を色で表現します（ヒートマップ）。これにより、モデルの予測の確信度を直感的に把握できます。
    
- **3Dレンダリング**: 閾値処理で抽出した骨折領域を3Dモデルとしてレンダリングし、骨全体の形状と合わせて立体的に観察できるようにします。
    
- **Attentionマップの可視化**: Attention Gateがどの領域に「注目」したかを可視化し、モデルの判断根拠を分析します。
    

---

#### **4. 期待される成果とリスク**

- **期待される成果**:
    
    - 分類モデルと比較して、骨折検出精度（特に再現率）と位置特定精度（Dice係数）の大幅な向上。
        
    - Attention機構により、微小な骨折や単一スライスでは不明瞭な骨折の検出能力が向上。
        
    - 医師の診断支援に資する、定量的かつ直感的な3D可視化手法の確立。
        
    - Attentionマップの分析による、モデルの解釈可能性の向上。
        
- **想定されるリスクと対策**:
    
    - **リスク1: 学習の不安定性**: GANの導入により、学習が収束しない可能性があります。
        
        - **対策**: 学習率のスケジューリング、損失関数の重み調整、段階的な学習（まずAttention U-Netを学習させ、次に全体をファインチューニングする等）。
            
    - **リスク2: 過学習**: データセットがモデルの複雑さに対して不足している場合。
        
        - **対策**: Phase 1で計画した強力なデータ拡張の徹底。ImageNetなどで事前学習済みのエンコーダを転移学習として利用する。
            
    - **リスク3: 高い計算コスト**: 3Dに近いデータを扱うため、モデルの学習に長時間を要します。
        
        - **対策**: 十分なGPUリソースの確保。モデルの軽量化（エンコーダの深さやパラメータ数の調整）も並行して検討します。