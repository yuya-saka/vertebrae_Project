
# 椎体部位ごとのサンプル数
============================================================
部位      全データ     VAE用(正常)

------------------------------------------------------------
T4             33              29
T5             33              27
T6             34              27
T7             36              29
T8             37              29
T9             37              25
T10            38              20
T11            38              11
T12            38              10
L1             38               7
L2             38               6
L3             38              11
L4             38              22
L5             38              26

============================================================
合計            514             279

===============================================================================================

# 患者ごとの正常・骨折椎体数

| 患者ID | 正常椎体数 | 骨折椎体数 | 正常椎体リスト                                   | 骨折椎体リスト                                               |     |
| ---- | ----- | ----- | ----------------------------------------- | ----------------------------------------------------- | --- |
| 1003 | 8     | 6     | T4, T5, T6, T7, T8, T9, L4, L5            | T10, T11, T12, L1, L2, L3                             | 14  |
| 1010 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, T11, L5      | T12, L1, L2, L3, L4                                   | 14  |
| 1012 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, L4, L5       | T11, T12, L1, L2, L3                                  | 14  |
| 1015 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, L4, L5       | T11, T12, L1, L2, L3                                  | 14  |
| 1016 | 9     | 5     | T4, T5, T6, T7, T8, T9, L3, L4, L5        | T10, T11, T12, L1, L2                                 | 14  |
| 1017 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, T11, T12     | L1, L2, L3, L4, L5                                    | 14  |
| 1021 | 7     | 7     | T4, T5, T6, T7, T8, T9, T10               | T11, T12, L1, L2, L3, L4, L5                          | 14  |
| 1025 | 8     | 6     | T4, T5, T6, T7, T8, T9, L4, L5            | T10, T11, T12, L1, L2, L3                             | 14  |
| 1027 | 6     | 6     | T6, T7, T8, L3, L4, L5                    | T9, T10, T11, T12, L1, L2                             | 12  |
| 1030 | 8     | 5     | T4, T5, T7, T8, T9, T10, L4, L5           | T11, T12, L1, L2, L3                                  | 13  |
| 1035 | 5     | 7     | T6, T7, T8, T9, L5                        | T10, T11, T12, L1, L2, L3, L4                         | 12  |
| 1038 | 1     | 13    | T4                                        | T5, T6, T7, T8, T9, T10, T11, T12, L1, L2, L3, L4, L5 | 14  |
| 1039 | 6     | 8     | T12, L1, L2, L3, L4, L5                   | T4, T5, T6, T7, T8, T9, T10, T11                      | 14  |
| 1043 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, T11, L5      | T12, L1, L2, L3, L4                                   | 14  |
| 1045 | 1     | 13    | T4                                        | T5, T6, T7, T8, T9, T10, T11, T12, L1, L2, L3, L4, L5 | 14  |
| 1046 | 6     | 4     | T8, T9, T10, T11, T12, L1                 | L2, L3, L4, L5                                        | 10  |
| 1047 | 8     | 6     | T4, T5, T12, L1, L2, L3, L4, L5           | T6, T7, T8, T9, T10, T11                              | 14  |
| 1049 | 5     | 9     | L1, L2, L3, L4, L5                        | T4, T5, T6, T7, T8, T9, T10, T11, T12                 | 14  |
| 1051 | 7     | 7     | T4, T5, T6, T7, T8, T9, T10               | T11, T12, L1, L2, L3, L4                              | 14  |
| 1052 | 8     | 6     | T4, T5, T6, T7, L2, L3, L4, L5            | T8, T9, T10, T11, T12, L1                             | 14  |
| 1054 | 8     | 6     | T4, T5, T6, T7, T8, L3, L4, L5            | T9, T10, T11, T12, L1, L2                             | 14  |
| 1055 | 3     | 11    | L3, L4, L5                                | T4, T5, T6, T7, T8, T9, T10, T11, T12, L1, L2         | 14  |
| 1059 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, T11, T12     | L1, L2, L3, L4, L5                                    | 14  |
| 1060 | 7     | 7     | T4, T5, T6, T7, T8, T9, T10               | T11, T12, L1, L2, L3, L4                              | 14  |
| 1061 | 7     | 7     | T4, T5, T6, T7, T8, L4, L5                | T9, T10, T11, T12, L1, L2, L3                         | 14  |
| 1062 | 5     | 9     | T4, T5, T6, T7, T8                        | T9, T10, T11, T12, L1, L2, L3, L4, L5                 | 14  |
| 1067 | 6     | 5     | T7, T8, T9, T10, L4, L5                   | T11, T12, L1, L2, L3                                  | 11  |
| 1069 | 10    | 4     | T4, T5, T6, T7, T8, T9, T10, T11, T12, L1 | L2, L3, L4, L5                                        | 14  |
| 1070 | 8     | 6     | T4, T5, T6, T7, T8, T9, L4, L5            | T10, T11, T12, L1, L2, L3                             | 14  |
| 1073 | 4     | 4     | T10, T11, T12, L1                         | L2, L3, L4, L5                                        | 8   |
| 1074 | 10    | 4     | T4, T5, T6, T7, T8, T9, T10, T11, T12, L5 | L1, L2, L3, L4                                        | 14  |
| 1075 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, T11, T12     | L1, L2, L3, L4, L5                                    | 14  |
| 1077 | 10    | 4     | T8, T9, T10, T11, T12, L1, L2, L3, L4, L5 | T4, T5, T6, T7                                        | 14  |
| 1079 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, L4, L5       | T11, T12, L1, L2, L3                                  | 14  |
| 1080 | 9     | 5     | T4, T5, T6, T7, T8, T9, L3, L4, L5        | T10, T11, T12, L1, L2                                 | 14  |
| 1082 | 8     | 6     | T4, T5, T6, T7, L2, L3, L4, L5            | T8, T9, T10, T11, T12, L1                             | 14  |
| 1083 | 9     | 5     | T4, T5, T6, T7, T8, T9, T10, L4, L5       | T11, T12, L1, L2, L3                                  | 14  |
| 1084 | 10    | 4     | T4, T5, T6, T7, T8, T9, T10, T11, L4, L5  | T12, L1, L2, L3                                       | 14  |

### 1. 🧪 Testデータの選定（8症例）

**選定基準：** 学習に使わず、最終評価のみに使用します。T4〜L5のすべての椎体レベルで、少なくとも1つ以上の骨折例が含まれるように、「特徴的な症例」をピックアップしました。

|**ID**|**骨折数**|**選定理由（カバーする重要部位）**|
|---|---|---|
|**1077**|4|**高位胸椎特化型**。希少な **T4, T5, T6, T7** の骨折を含むため必須。|
|**1046**|4|**下位腰椎特化型**。 **L2, L3, L4, L5** の連続骨折。下位の評価に重要。|
|**1038**|13|**多発骨折（重度）**。T5〜L5までほぼ全滅。高負荷なケースでの精度検証用。|
|**1027**|6|**中位胸椎〜上位腰椎**。T9〜L2と広範囲。|
|**1055**|11|**広範囲（T〜L）**。T4〜L2まで連続。高位胸椎のテストデータを補強。|
|**1074**|4|**腰椎中心**。L1〜L4。|
|**1084**|4|**胸腰移行部**。T12〜L3。最も一般的な骨折パターンの確認。|
|**1003**|6|**バランス型**。T10〜L3。標準的な症例。|

> **✅ Check:** この8症例だけで、T4からL5まで全てのレベルの「骨折」が含まれています。

---
### 2. 📚 Trainデータの構成と5-Fold CV（30症例）

残りの30症例を学習データとします。

Cross Validation (CV) を行う際、各Fold（グループ）の「難易度」を均一にするため、「骨折数が多い症例（Heavy）」と「少ない症例（Light）」を各Foldにバランスよく分散させます。

#### 分割方針 (Stratified K-Fold)

- **Total:** 30症例
    
- **1 Foldあたり:** 6症例（学習24症例 : 検証6症例 で回す）
    
以下の通り、骨折の「重症度」と「部位」を考慮して5つのグループに分けました。

| **Fold ID** | **割当症例ID (計6症例)**                                   | **特徴・バランス意図**                      | 正常データ数 |
| ----------- | --------------------------------------------------- | ---------------------------------- | ------ |
| **Fold 1**  | **1045**(13個), **1062**(9個), 1021, 1010, 1073, 1083 | **超多発(T4含む)** を含む高難易度セット。          |        |
| **Fold 2**  | **1039**(8個), **1051**(7個), 1030, 1012, 1067, 1080  | **高位(T4-T11)骨折**を含むセット。上位胸椎の学習に重要。 |        |
| **Fold 3**  | **1049**(9個), **1060**(7個), 1052, 1015, 1069, 1079  | **L1-L5腰椎多発** と **胸椎多発** のミックス。    |        |
| **Fold 4**  | **1035**(7個), **1054**(6個), 1025, 1016, 1043, 1059  | 中位胸椎〜腰椎の標準的なパターンを集めたセット。           |        |
| **Fold 5**  | **1047**(6個), **1082**(6個), 1061, 1017, 1070, 1075  | 胸腰移行部を中心に、全体的にバランスが良いセット。          |        |

---
### 3. 🚀 実装・運用のポイント

この分割を用いた学習フローは以下のようになります。

#### Step A: VAEの学習（正常パターンの獲得）

- **使用データ:** Trainデータ（30症例）に含まれる **「正常椎体」のみ** を使用します。
    
- **重要:**
    
    - Testデータ（8症例）の正常椎体は、**絶対にVAEの学習に含めてはいけません**（Data Leakageになります）。
        
    - CVを行う場合、厳密には「CVごとの学習データ（24症例）の正常椎体」でVAEを作り直すのが理想ですが、計算コスト削減のため、**Train全データ（30症例）の正常椎体で1つの「共通VAE」を作ってしまう**というアプローチも（コンペ等では非推奨ですが）実務的な初期検討としてはありです。
        
    - しかし、論文や厳密な評価を目指すなら、**FoldごとにVAEも作り直すべき**です。
        
        - _Fold 1の時:_ Fold 2,3,4,5 (24症例) の正常椎体でVAE学習 → そのVAEでFold 1の再構成誤差を作成。
            
#### Step B: 骨折検出モデルの学習（弱教師あり）

- **使用データ:** Trainデータ（30症例）の **「全椎体（正常＋骨折）」**。
    
- **CVの流れ:**
    
    1. Fold 1〜5をループ。
        
    2. 例：Fold 1が検証用の場合、Fold 2〜5（24症例）でU-Net等を学習。
        
    3. Fold 1（6症例）で精度検証（ここでハイパーパラメータ調整）。
        
    4. 5回繰り返して、モデルの平均性能を確認。
        
#### Step C: 最終評価

- CVで最適なパラメータが決まったら、**Trainデータ（30症例）全て**を使って最終モデルを学習させます。
    
- その「最終モデル」を使って、取っておいた **Testデータ（8症例）** を推論し、最終的なスコア（感度、特異度、F1スコアなど）を算出します。


### 📊 1. 全体像（Train 30症例の内訳）

まず、30症例全体（5 Fold合計）のプールにあるデータ総数です。

|**カテゴリ**|**椎体数 (個)**|**割合**|
|---|---|---|
|**正常椎体 (Normal)**|**225**|55.1%|
|**骨折椎体 (Fracture)**|**183**|44.9%|
|**合計 (Total)**|**408**|100%|

> **Point:** 通常の医療データでは正常が圧倒的に多くなりがちですが、このデータセットは骨折症例を集めているため、学習時のクラスバランスが非常に良いです。

---
### 🔢 2. 各Foldごとのデータ分布

各Foldに含まれるデータ数です。ここから「学習（4つ）」と「検証（1つ）」を選びます。

| **Fold名**  | **正常椎体数 (VAE用)** | **骨折椎体数** | **合計椎体数 (検出モデル用)** | **備考**               |
| ---------- | ---------------- | --------- | ------------------ | -------------------- |
| **Fold 1** | 35               | 43        | 78                 | 骨折多め (High Fracture) |
| **Fold 2** | 45               | 35        | 80                 | バランス型                |
| **Fold 3** | 48               | 36        | 84                 | 正常やや多め               |
| **Fold 4** | 48               | 34        | 82                 | 正常やや多め               |
| **Fold 5** | 49               | 35        | 84                 | 正常やや多め               |

---
### 🚀 3. 交差検証 (CV) 時の「学習データ数」

実際に `model.fit()` に入力されるデータ数です。（学習用4 Foldの合計）

#### A. フェーズ1：VAE学習 (正常データのみ使用)

ここが最もデータ数がシビアな部分です。

|**検証にするFold**|**学習に使う正常データ数**|**考察**|
|---|---|---|
|Fold 1が検証|**190**|最もデータが多いパターン。|
|Fold 2が検証|**180**||
|Fold 3が検証|**177**||
|Fold 4が検証|**177**||
|Fold 5が検証|**176**|最もデータが少ないパターン。|

- **分析:** 学習データは約180個前後です。3D CNNの学習にはかなり少ないため、VAEの学習時は**回転、反転、スケーリング、ノイズ付加などのData Augmentation（水増し）を強めにかける**必要があります。
    
#### B. フェーズ2：骨折検出モデル学習 (全データ使用)

ここでは「正常」と「骨折」の比率（Balance）にも注目してください。

|**検証にするFold**|**学習データ総数**|**内訳 (正常 : 骨折)**|**骨折含有率**|
|---|---|---|---|
|Fold 1が検証|**330**|190 : 140|42.4%|
|Fold 2が検証|**328**|180 : 148|45.1%|
|Fold 3が検証|**324**|177 : 147|45.3%|
|Fold 4が検証|**326**|177 : 149|45.7%|
|Fold 5が検証|**324**|176 : 148|45.6%|

- **分析:** 学習データは約325個前後です。
    
- **バランス:** 骨折データの割合が **42%〜46%** の範囲に収まっており、非常に安定しています。これはLoss関数で極端な重み付け（Weighted Loss）をしなくても学習が進みやすい理想的な比率です。
    
---
### 🧪 参考：Hold-out Testデータ（8症例）

最終評価用として取っておくデータの規模感です。

- **正常椎体:** 54個
    
- **骨折椎体:** 52個
    
- **合計:** 106個
    

こちらもほぼ 1:1 のバランスになっており、精度の評価（感度・特異度）が出しやすい構成です。

### 💡 まとめと推奨設定

1. **VAEの学習:**
    
    - 生データ数が約180個しかないので、EpochごとのAugmentationで実質的なバリエーションを増やすことが必須です。
        
    - 過学習（Overfitting）しやすいため、Validation Loss（検証データの再構成誤差）が下がらなくなったら早めに止める **Early Stopping** を必ず入れてください。
        
2. **骨折検出モデル:**
    
    - データバランスが良いので、最初はLoss関数のクラス重みを `1:1` で始めても問題なさそうです。
        
    - もし「見逃し（False Negative）」を減らしたい場合は、骨折クラスのLossを少し重くする（例: 骨折側を1.2倍など）微調整で対応できます。
        

このデータ数とバランスであれば、提案の手法（VAE + 弱教師あり）で十分に勝負できる構成になっています。