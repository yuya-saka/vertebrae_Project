### **研究実装計画書：pix2pixとLSTMを用いた椎骨骨折セグメンテーションの新アプローチ**

#### **1. 研究背景と目的**

前回の研究「スライス画像分類による椎骨骨折検出」では、ResNet18を用いた2クラス分類モデルを構築した 。しかし、テストデータにおける統合後のPR-AUCは0.17と低く、骨折領域の位置特定精度に深刻な課題が残った 。この課題は、スライス単位の「分類」タスクでは、骨折の正確な「位置」情報を捉えきれないという根本的な問題に起因する。

本研究では、この課題を克服するため、アプローチを根本から見直す。**pix2pix（Attention U-Net）による画像セグメンテーション**と**LSTMによるスライス間コンテキストの学習**を融合させた新たな時空間モデルを構築し、CT画像から椎骨骨折領域を3次元的に高精度で特定することを目的とする。

---

#### **2. 提案手法の概要**

本研究では、以下の4つのステップで骨折検出と評価を行う。

1. **手法の転換 (pix2pix)**: 骨折の有無を判定する「分類」から、骨折領域をピクセル単位で塗り分ける「セグメンテーション」へタスクを転換する。これにより、骨折の位置と形状を直接的に捉える。
    
2. **3D情報の導入 (LSTM)**: 連続する複数枚の2Dスライス画像を1つのシーケンスデータとしてLSTMに入力し、スライス間の連続性（奥行き情報）を学習させる。
    
3. **2.5D統合による3D復元**: 各椎体（T4-L5）ごとに独立して推論を行い、得られた2Dのセグメンテーション結果を元の3Dボリュームデータ上で統合（平均化や投票方式）し、3次元の骨折確率マップを生成する。
    
4. **評価と可視化**: 3Dの確率マップを教師データ（3Dアノテーションマスク）と比較し、Dice係数やIoUなどのセグメンテーション指標で精度を評価する。結果はヒートマップや3Dレンダリングで可視化する。
    

---

#### **3. 実装計画 (Implementation Plan)**

**Phase 1: データ前処理 (Data Preprocessing)**

- **椎体領域の抽出**: 既存研究と同様に、T4からL5までの各椎体をバウンディングボックスで手動または自動で切り出す 。
    
- **シーケンスデータの作成**:
    
    - 各椎体のスライス群をシーケンスデータに変換する。例えば、5枚の連続するスライス（`[t-2, t-1, t, t+1, t+2]`）を入力とし、中央のスライス（`t`）の骨折セグメンテーションマスクを正解ラベルとするデータセットを構築する。

**Phase 2: モデルアーキテクチャ設計と実装**

- **基本アーキテクチャ**: `pix2pix (Attention U-Net) + LSTM`
    
- **コンポーネント1: pix2pix (Attention U-Net Generator)**
    
    - 役割: 入力されたCT画像スライスから空間的特徴を抽出し、骨折領域のセグメンテーションマップを生成する。Attention機構を導入し、骨折領域に関連の強い特徴に焦点を当てる。
        
- **コンポーネント2: LSTM**
    
    - 役割: 連続するスライスから抽出された特徴量の系列を受け取り、時間的（スライス間）な依存関係を学習する。
        
- **統合アーキテクチャ案**:
    
    - U-Netのエンコーダ（特徴抽出部）で各スライスの特徴ベクトルを抽出する。
        
    - 抽出された特徴ベクトルのシーケンスをLSTM層に入力する。
        
    - LSTM層の出力をU-Netのデコーダ（画像再構築部）の対応する層にスキップ接続と結合させ、最終的なセグメンテーションマップを生成する。
        

**Phase 3: 学習と評価 (Training & Evaluation)**

- **学習**:
    
    - **損失関数**: pix2pixの学習に倣い、GANの敵対的損失と、生成画像と正解ラベル間のL1損失（またはDice損失などのセグメンテーション用損失）を組み合わせた複合損失関数を使用する。
        
    - **最適化**: Adamなどの最適化アルゴリズムを使用 。
        
- **評価**:
    
    - **2.5D評価**: まずは2Dスライス単位でセグメンテーション精度を評価する（Dice係数、IoU）。
        
    - **3D評価**: Phase 2で生成した3D確率マップに対し、適切な閾値を設定して二値化。この3D予測マスクと3D正解マスクを比較し、3D Dice係数、IoU、適合率、再現率を算出する。
        

**Phase 4: 結果の可視化 (Results Visualization)**

- **ヒートマップ可視化**: 3D確率マップを元のCT画像に重ね合わせ、骨折確率を色で表現する（ヒートマップ）。これにより、モデルの予測の確信度を直感的に把握できる。
    
- **3Dレンダリング**: 閾値処理で抽出した骨折領域を3Dモデルとしてレンダリングし、骨全体の形状と合わせて立体的に観察できるようにする。
    

---

#### **4. 期待される成果とリスク**

- **期待される成果**:
    
    - 分類モデルと比較して、骨折検出精度（特に再現率）と位置特定精度（Dice係数）の大幅な向上。
        
    - 微小な骨折や、単一スライスでは不明瞭な骨折の検出能力の向上。
        
    - 医師の診断支援に資する、定量的かつ直感的な3D可視化手法の確立。
        
- **想定されるリスクと対策**:
    
    - **リスク1: 学習の不安定性**: GANとLSTMの組み合わせにより、学習が収束しない可能性がある。
        
        - **対策**: 学習率のスケジューリング、損失関数の重み調整、段階的な学習（まずU-Netを学習させ、次に全体をファインチューニングする等）。
            
    - **リスク2: 過学習**: データセットがモデルの複雑さに対して不足している。
        
        - **対策**: Phase 1で計画した強力なデータ拡張の徹底。転移学習（ImageNetなどで事前学習済みのエンコーダを利用）の活用。
            
    - **リスク3: 高い計算コスト**: モデルの学習に長時間を要する。
        
        - **対策**: 計算リソースの確保。モデルの軽量化（層数やパラメータの削減）も視野に入れる。


