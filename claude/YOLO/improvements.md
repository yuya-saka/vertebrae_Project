## データ前処理最適化

### YOLOのbbox作り方（マルチインスタンス対応）

#### データセットの特性（調査結果 2025/10/19）
- 骨折マスクは値0～6で構成（0=背景, 1～6=各骨折インスタンス）
- 各非ゼロ値は異なる骨折領域を示す（専門医による個別アノテーション）
- **骨折分布:**
  - 単一骨折: 96椎体 (70.6%)
  - 複数骨折: 40椎体 (29.4%)
    - 2個: 24椎体
    - 3個: 10椎体
    - 4個: 5椎体
    - 5個: 1椎体
- 1椎体あたり最大5つの独立した骨折が存在

#### BBox作成アルゴリズム

**入力:** マスク画像（NIfTI形式、値0～6）
**出力:** YOLO形式テキストファイル（1画像に複数行可）

**処理フロー:**
```python
for mask_value in range(1, 7):  # 値1～6をループ
    binary_mask = (mask_data == mask_value)

    if not binary_mask.any():
        continue  # この値が存在しない場合スキップ

    # BBox座標抽出
    y_coords, x_coords = np.where(binary_mask)
    y_min, y_max = y_coords.min(), y_coords.max()
    x_min, x_max = x_coords.min(), x_coords.max()

    # YOLO形式に正規化 [0, 1]
    x_center = (x_min + x_max) / 2 / width
    y_center = (y_min + y_max) / 2 / height
    bbox_width = (x_max - x_min) / width
    bbox_height = (y_max - y_min) / height

    # 品質チェック（後述）
    if is_valid_bbox(bbox_width, bbox_height, area):
        # YOLO形式で保存: <class> <x_center> <y_center> <width> <height>
        write_line(f"0 {x_center} {y_center} {bbox_width} {bbox_height}")
```

**YOLO形式例（1スライスに2つの骨折）:**
```
# case1003_vertebra31_slice119.txt
0 0.573 0.384 0.089 0.052  # 骨折インスタンス1
0 0.536 0.531 0.065 0.048  # 骨折インスタンス2
```

#### BBox品質管理

**フィルタリング条件:**
1. **最小面積閾値:** BBox面積 < 50px² は除外（ノイズ除去）
2. **妥当性チェック:**
   - 幅・高さが0でない
   - 正規化座標が [0, 1] の範囲内
   - アスペクト比が極端でない（例: 1:20以上は要確認）
3. **画像端処理:** BBoxが画像端で切れている場合は保持（骨折の一部）

**可視化検証:**
- ランダムサンプリング（各ケース10%）で目視確認
- 複数BBoxが正しく分離されているか確認
- マスク値と BBox の対応を色分け表示

#### 実装上の注意点

1. **マスク値の連続性:** 値1, 3のみ存在（値2なし）のケースあり → 全値をループ
2. **スライス間の一貫性:** 同じ骨折インスタンスが連続スライスで同じ値とは限らない
   → LSTM段階で追跡・統合が必要
3. **クラスID:** 初期実装は全て class=0（骨折/非骨折の二値分類）
   → 将来的に椎体別分類（14クラス）に拡張可能

#### データ統計レポート

変換後に以下の統計を出力:
- 総BBox数 / 総スライス数
- スライスあたりBBox数の分布（1個, 2個, ...）
- BBoxサイズの分布（min, max, median）
- 極小/極大BBoxのリスト（要目視確認）

### 2025/10/16
- 切り出した画像データは大きくても256×256の範囲内
- 画像データはリサイズせず、256×256に合わせる、小さい画像は、ゼロパディングで穴埋めで合わせる、これをYOLOの学習パラメータとする

### 2025/10/19
- **骨折マスクのマルチインスタンス特性を発見**
  - マスク値1～6が異なる骨折インスタンスを示す
  - 29.4%の椎体に複数の独立した骨折が存在
  - 各マスク値ごとに独立BBoxを生成する実装方針を決定
  - 連結成分解析は不要（既にインスタンス分離済み）
  - 調査対象: 全trainデータセットの骨折椎体136個
